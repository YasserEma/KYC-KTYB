# منصة اعرف عميلك - KYC Platform

منصة شاملة لإدارة اعرف عميلك (KYC) والامتثال وإدارة المخاطر مبنية باستخدام Next.js و Supabase.

## نظرة عامة

هذه المنصة توفر حلولاً متكاملة لإدارة الكيانات والامتثال للوائح اعرف عميلك مع دعم متعدد المستأجرين وواجهة مستخدم حديثة.

## المميزات الرئيسية

### إدارة المصادقة

#### تسجيل الدخول
- صفحة تسجيل دخول مخصصة لكل مستأجر مع العلامة التجارية
- مصادقة آمنة باستخدام Supabase Auth
- إعادة توجيه تلقائية إلى صفحة الكيانات بعد تسجيل الدخول الناجح

#### إعادة تعيين كلمة المرور
- **تحديث جديد**: التحقق من وجود البريد الإلكتروني قبل إرسال رابط إعادة التعيين
- **تحديث جديد**: رسالة خطأ واضحة للبريد الإلكتروني غير المسجل: "هذا البريد الإلكتروني غير مسجل."
- **تحديث جديد**: رسالة نجاح عند إرسال الرابط: "تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني."
- **إصلاح تقني**: استخدام `exchangeCodeForSession` لحل مشكلة "Auth session missing!"
- **تحديث جديد**: بعد إعادة تعيين كلمة المرور بنجاح، يتم إعادة توجيه المستخدم إلى صفحة تسجيل الدخول
- **تحديث جديد**: يتطلب من المستخدم تسجيل الدخول يدوياً باستخدام بيانات الاعتماد الجديدة
- رسالة نجاح واضحة: "تم تحديث كلمة المرور بنجاح. يرجى تسجيل الدخول باستخدام بيانات الاعتماد الجديدة."
- تسجيل خروج تلقائي قبل إعادة التوجيه لضمان الأمان

#### تسجيل الخروج
- **تحديث جديد**: زر تسجيل خروج في صفحة الكيانات
- **تحديث جديد**: عند النقر على تسجيل الخروج، يتم تسجيل خروج المستخدم وإعادة توجيهه إلى صفحة تسجيل الدخول
- تصميم واضح ومميز للزر مع أيقونة تسجيل الخروج

### إدارة الكيانات

#### صفحة الكيانات
- عرض جميع الكيانات في جدول تفاعلي
- **تحديث جديد**: رأس الصفحة يحتوي على زر تسجيل الخروج
- بحث وتصفية متقدمة
- تصدير البيانات إلى CSV
- عرض تفاصيل الكيان في درج جانبي

#### جدول الأعمال (BusinessTable)
- جدول قابل للتخصيص مع إمكانيات الفرز والبحث
- أعمدة قابلة للإخفاء والإظهار
- دعم التصفية المتقدمة
- تصدير البيانات

### الأمان والامتثال

#### سياسات الأمان على مستوى الصفوف (RLS)
- حماية البيانات على مستوى المستأجر
- تحكم في الوصول بناءً على أدوار المستخدمين
- تدقيق شامل لجميع العمليات

#### تسجيل التدقيق
- تسجيل جميع العمليات الحساسة
- تتبع تسجيل الدخول والخروج
- مراقبة الوصول إلى البيانات

## التقنيات المستخدمة

- **Frontend**: Next.js 14 مع App Router
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **UI**: Tailwind CSS
- **التدويل**: next-intl
- **TypeScript**: للتطوير الآمن

## بدء الاستخدام

### المتطلبات
- Node.js 18+ 
- npm أو yarn
- حساب Supabase

### التثبيت

```bash
# استنساخ المشروع
git clone [repository-url]
cd kyc-platform

# تثبيت التبعيات
npm install

# إعداد متغيرات البيئة
cp .env.example .env.local
# قم بتحديث متغيرات Supabase في .env.local

# تشغيل الخادم المحلي
npm run dev
```

### الإعداد

1. **إعداد Supabase**:
   - إنشاء مشروع جديد في Supabase
   - تشغيل ملفات SQL لإنشاء الجداول والسياسات
   - تحديث متغيرات البيئة

2. **إعداد المستأجرين**:
   - إضافة بيانات المستأجرين في جدول `tenants`
   - تخصيص العلامة التجارية لكل مستأجر

3. **إعداد المستخدمين**:
   - إنشاء حسابات المستخدمين
   - تعيين الأدوار والصلاحيات

## سير العمل الجديد للمصادقة

### إعادة تعيين كلمة المرور
1. المستخدم يطلب إعادة تعيين كلمة المرور من صفحة تسجيل الدخول
2. **محسّن**: النظام يتحقق أولاً من وجود البريد الإلكتروني في قاعدة البيانات
   - إذا لم يكن البريد مسجلاً: عرض رسالة "هذا البريد الإلكتروني غير مسجل."
   - إذا كان البريد مسجلاً: المتابعة لإرسال رابط إعادة التعيين
3. **محسّن**: عرض رسالة نجاح واضحة: "تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني."
4. استلام رابط إعادة التعيين عبر البريد الإلكتروني
5. **إصلاح تقني**: استخدام `exchangeCodeForSession` لاستعادة الجلسة من رابط إعادة التعيين
   - هذا يحل مشكلة "Auth session missing!" التي كانت تحدث سابقاً
   - النظام يستخرج الكود من رابط إعادة التعيين ويحوله إلى جلسة صالحة
6. إدخال كلمة المرور الجديدة وتأكيدها
7. **جديد**: إعادة توجيه إلى صفحة تسجيل الدخول مع رسالة نجاح
8. **جديد**: المستخدم يحتاج لتسجيل الدخول يدوياً بكلمة المرور الجديدة

#### الشرح التقني لإصلاح "Auth session missing!"
المشكلة السابقة كانت أن صفحة إعادة تعيين كلمة المرور تحاول الوصول إلى جلسة المستخدم مباشرة دون استعادتها من رابط إعادة التعيين. الحل الجديد:

1. **استخراج الكود**: النظام يستخرج معامل `code` من رابط إعادة التعيين
2. **تبادل الكود**: استخدام `supabase.auth.exchangeCodeForSession(code)` لتحويل الكود إلى جلسة صالحة
3. **التحديث الآمن**: بعد استعادة الجلسة، يمكن تحديث كلمة المرور بأمان باستخدام `supabase.auth.updateUser()`

هذا النهج يضمن أن المستخدم لديه جلسة صالحة قبل محاولة تحديث كلمة المرور، مما يمنع حدوث أخطاء المصادقة.

### تسجيل الخروج من صفحة الكيانات
1. المستخدم ينقر على زر "تسجيل الخروج" في أعلى صفحة الكيانات
2. يتم تسجيل خروج المستخدم من Supabase
3. إعادة توجيه تلقائية إلى صفحة تسجيل الدخول
4. تحديث الصفحة لضمان مسح جميع البيانات المحلية

## الهيكل التنظيمي

```
src/
├── app/
│   ├── [locale]/
│   │   ├── auth/
│   │   │   ├── login/          # صفحة تسجيل الدخول
│   │   │   ├── signup/         # صفحة التسجيل
│   │   │   ├── forgot-password/ # نسيان كلمة المرور
│   │   │   └── reset-password/  # إعادة تعيين كلمة المرور
│   │   └── entities/
│   │       ├── page.tsx        # صفحة الكيانات الرئيسية
│   │       ├── EntitiesClient.tsx # مكون العميل للكيانات
│   │       ├── EntitiesHeader.tsx # رأس الصفحة مع زر تسجيل الخروج
│   │       └── EntityDetailsDrawer.tsx # درج تفاصيل الكيان
│   └── api/
│       └── auth/               # نقاط النهاية للمصادقة
├── components/
│   └── ui/
│       └── BusinessTable.tsx   # جدول الأعمال القابل لإعادة الاستخدام
├── lib/
│   └── supabase/              # إعدادات Supabase
└── messages/
    ├── en.json                # الرسائل الإنجليزية
    └── ar.json                # الرسائل العربية
```

## المساهمة

نرحب بالمساهمات! يرجى اتباع الإرشادات التالية:

1. إنشاء فرع جديد للميزة أو الإصلاح
2. اتباع معايير الكود المحددة
3. إضافة اختبارات للميزات الجديدة
4. تحديث الوثائق حسب الحاجة

## الدعم

للحصول على الدعم أو الإبلاغ عن المشاكل، يرجى إنشاء issue في مستودع GitHub أو التواصل مع فريق التطوير.

## الترخيص

هذا المشروع مرخص تحت [اسم الترخيص] - راجع ملف LICENSE للتفاصيل.